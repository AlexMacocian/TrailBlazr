<DynamicComponent Type="@this.CurrentViewType" Parameters="@this.CurrentParameters" />

@using Microsoft.Extensions.Logging
@using TrailBlazr.Models
@using TrailBlazr.Services
@code {
    [Inject]
    public required IViewManager ViewManager { get; init; }

    [Inject]
    public required NavigationManager NavigationManager { get; init; }

    [Inject]
    public required ILogger<ViewContainer> Logger { get; init; }

    protected Type CurrentViewType { get; set; } = typeof(EmptyComponent);

    protected Dictionary<string, object> CurrentParameters { get; set; } = [];

    protected override void OnInitialized()
    {
        if (this.ViewManager is null)
        {
            throw new InvalidOperationException("ViewManager is not initialized.");
        }

        ((ViewManager)this.ViewManager).ContainerInitialized(this.NavigationManager);
        this.ViewManager.ShowViewRequested += this.UpdateCurrentView;
    }

    private void UpdateCurrentView(object? _, ViewRequest request)
    {
        try
        {
            this.CurrentParameters = request.RouteValues.ToDictionary();
            this.CurrentViewType = request.ViewType;
            this.StateHasChanged();
        }
        catch(Exception ex)
        {
            this.Logger.LogError(ex, "Error changing view to {newView}", request.ViewType.Name);
        }
    }
}
